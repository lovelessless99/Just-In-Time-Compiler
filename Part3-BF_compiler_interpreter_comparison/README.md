# Part-3 Brainfuck compiler and interpreter æ¯”è¼ƒèˆ‡æ¢è¨
åœ¨ Part 2, æˆ‘å€‘å¯¦ä½œäº† BF interpreter, BF sed-interpreter, BF compiler å¯ä»¥å¹«åŠ©æˆ‘å€‘åŸ·è¡Œ Brainfuck çš„ç¨‹å¼ï¼Œåœ¨å¯¦ä½œ Just in time compiler ä¹‹å‰ï¼Œæˆ‘å€‘å…ˆä¾†æ¯”è¼ƒä¸‰å€‹ç¨‹å¼çš„æ•ˆç‡ï¼Œä»¥åŠåšå€‹å¾®æ·±å…¥æ¢è¨ï¼Œæˆ‘å…ˆå¤§æ¦‚ç•«ä¸€ä¸‹Part2çš„æ¶æ§‹

![](part2-flow.png)



# æ¸¬è©¦ç¨‹å¼ - ç¢å½¢(mandelbrot) 
ç¢å½¢ç‚º[æ›¼å¾·åšé›†åˆ](https://zh.wikipedia.org/wiki/%E6%9B%BC%E5%BE%B7%E5%8D%9A%E9%9B%86%E5%90%88)ï¼Œæ˜¯å€‹å¾ˆè¤‡é›œçš„åœ–å½¢ï¼Œç›¸ä¿¡æœ‰äº›äººå¯èƒ½æœ‰å°è±¡é€™å€‹åœ–ç‰‡

![mandelbrot](https://uk.mathigon.org/content/fractals/images/mandelbrot.png)

ç”±æ–¼ç”Ÿæˆåœ–å½¢çš„è¤‡é›œæ€§ï¼Œé€ æˆç®—ç¹ªç•«é¢çš„é€Ÿåº¦**éå¸¸æ…¢**ï¼Œå› æ­¤æœ‰æ™‚å€™å¾ˆé©åˆç”¨ä¾†ç•¶ä½œæ¸¬è©¦æ•ˆç‡çš„å·¥å…·ã€‚æˆ‘å€‘æ¸¬è©¦çš„ç¨‹å¼æ˜¯`ç”¢ç”Ÿç¢å½¢çš„ brainfuck ç¨‹å¼ç¢¼`ï¼Œä¸¦ä½¿ç”¨æˆ‘å€‘åœ¨ part2 å¯«çš„ä¸‰å€‹åŸ·è¡Œå·¥å…·ï¼ŒåŸ·è¡Œé€™æ®µç¨‹å¼ç¢¼ï¼Œçœ‹çœ‹æœ‰åŸ·è¡Œçš„é€Ÿåº¦ğŸ˜
ä»¥ä¸‹ç¯€éŒ„ç¨‹å¼ç¢¼ç‚º`mandelbrot.bf`ï¼Œç¸½ä¹‹è¦åšéå¸¸å¤šçš„å‹•ä½œã€‚
```brainfuck
+++++++++++++[->++>>>+++++>++>+<<<<<<]>>>>>++++++>--->>>>>>>>>>+++++++++++++++[[
>>>>>>>>>]+[<<<<<<<<<]>>>>>>>>>-]+[>>>>>>>>[-]>]<<<<<<<<<[<<<<<<<<<]>>>>>>>>[-]+
<<<<<<<+++++[-[->>>>>>>>>+<<<<<<<<<]>>>>>>>>>]>>>>>>>+>>>>>>>>>>>>>>>>>>>>>>>>>>
>+<<<<<<<<<<<<<<<<<[<<<<<<<<<]>>>[-]+[>>>>>>[>>>>>>>[-]>>]<<<<<<<<<[<<<<<<<<<]>>
... 
```


# ä¸€ã€ç¬¬ä¸€éšæ®µ(Stage 1)æ•ˆç‡æ¯”è¼ƒ
æˆ‘å€‘åˆ©ç”¨ `time` é€™å€‹ unix æä¾›çš„æŒ‡ä»¤ä¾†æ¸¬è©¦ç¨‹å¼åŸ·è¡Œçš„æ™‚é–“ï¼Œä¸¦ä¸”æ­é…æˆ‘å¯«å¥½çš„ makefile åŠ shell scriptsã€‚åŸ·è¡Œæ–¹æ³•å¦‚ä¸‹ï¼Œå¾ˆç°¡å–®å§ ğŸ˜ï¼Œ**å…ˆé€²åˆ° stage 1 çš„è³‡æ–™å¤¾**
```bash
make
```
æˆ‘çš„ makefileï¼Œç°¡å–®ä¾†èªªï¼Œå°±æ˜¯æŠŠ Part2 çš„æª”æ¡ˆç›´è­¯å™¨ã€ç·¨è­¯å™¨ã€sed æ­é…ç¢å½¢æ¸¬è©¦æª”æ¡ˆ `mandelbort.bf`å…¨éƒ¨å»ºç«‹å¥½ï¼Œå†åˆ©ç”¨shell script test.sh åŸ·è¡Œç›´è­¯å™¨ã€ç·¨è­¯å™¨ã€sedï¼Œä¸¦è¼¸å‡ºåŸ·è¡Œæ™‚é–“ï¼Œæœ€å¾Œåˆ©ç”¨ report.py é€²è¡Œæ¯”è¼ƒèˆ‡ç¹ªåœ–

> è«‹å…ˆå®‰è£ python çš„ matplotlib åŠ seaborn

åŸ·è¡Œéç¨‹å¦‚ä¸‹åœ–ï¼Œå¯ä»¥çœ‹åˆ°å…¨éƒ¨åŸ·è¡Œéç¨‹åŠæœ€å¾ŒåŸ·è¡Œæ™‚é–“è¼¸å‡ºè¡¨æ ¼
![command execute](https://i.imgur.com/uUyPjOC.png)

çµæœå¦‚ä¸‹åœ– (è »ç¾çš„é½ğŸ¤£)

![final](https://i.imgur.com/2ninvq4.png)

å¯ä»¥è§€å¯Ÿå‡ºï¼Œç›´è­¯å™¨çš„åŸ·è¡Œæ™‚é–“æ˜é¡¯é•·å¾ˆå¤šï¼Œå…¶æ¬¡æ˜¯ sed å†ä¾†æ˜¯ compilerï¼Œæ¥ä¸‹ä¾†ï¼Œæˆ‘å°‡ä¸€ä¸€é—¡è¿°æ­¤çµæœã€‚

## 1.1 Interpreter vs sed (6x speed up)
å¾ˆå¤šäººå¯èƒ½æœƒèªç‚ºèªªï¼Œinterpreter åŸ·è¡Œé€Ÿåº¦æ…¢æ˜¯å› ç‚ºé‚Šè®€é‚ŠåŸ·è¡Œï¼Œé‚£æˆ‘åœ¨ part2 å¯¦ç¾çš„ sedï¼Œå…¶å¯¦ä¹Ÿç®—æ˜¯ interpreter çš„ä¸€ç¨®ï¼Œåªæ˜¯åˆ©ç”¨å°ç…§è¡¨å°æ‡‰åˆ° C çš„ç¨‹å¼ç¢¼ï¼Œå†é€²è¡Œç·¨è­¯ã€‚é‚£ä½ å¯èƒ½æœƒèª¤èª

* å› ç‚ºç›´è­¯å™¨è¦é‚Šè®€é‚Šç¿»è­¯ã€åŸ·è¡Œï¼Œè€Œ sed æ˜¯ç¶“ç”±å°ç…§è¡¨è½‰åŒ–æˆ C ç¨‹å¼ç¢¼ç·¨è­¯æˆæ©Ÿå™¨ç¢¼ï¼Œæ©Ÿå™¨ç¢¼åŸ·è¡Œç•¶ç„¶æ¯”è¼ƒå¿«ã€‚

çš„ç¢ºã€‚é€™æˆ–è¨±æ˜¯ä¸€å€‹åŸå› ï¼Œä½†æˆ‘èªç‚ºæœ€ä¸»è¦çš„å·®ç•°æ˜¯`å¯¦ä½œæ–¹å¼`ï¼Œinterpreter åœ¨ Part2 çš„å¯¦ä½œæ–¹å¼ï¼Œé‡åˆ°è¿´åœˆæ™‚ï¼Œæœƒå¤šèŠ±æ™‚é–“O(n)å»æ‰¾åŒ¹é…çš„æ‹¬è™Ÿã€‚è€Œåœ¨sedçš„å°ç…§è¡¨ï¼Œæˆ‘å€‘åªæ˜¯ç°¡å–®è½‰æˆ while loopï¼Œä¸¦ä¸ç”¨å¤šèŠ±æ™‚é–“å»åŒ¹é…æ‹¬è™Ÿã€‚å› æ­¤åœ¨å°‹æ‰¾æ‹¬è™Ÿçš„åœ°æ–¹ï¼Œ**æˆ‘å€‘ç”± O(n) è½‰æˆ O(1)**ï¼Œæ•ˆç‡ä¸Šç•¶ç„¶å¿«å¾ˆå¤šã€‚ä½ å¯ä»¥æŠŠ sed çš„æ–¹æ³•ç•¶æˆæ˜¯ç›´è­¯å™¨çš„å°å°å„ªåŒ–ï¼Œä½†é€™å°å°å„ªåŒ–å°±å¿«äº† **6 å€å¤š**ã€‚

## 1.2 sed vs compiler (6x speed up)
æ¥ä¸‹ä¾†å°±æ˜¯æœ€ä»¤äººåŒªå¤·æ‰€æ€çš„åœ°æ–¹äº†ï¼Œé€™å…©ç¨®æ–¹å¼ï¼ŒåŒæ¨£çš„åŸ·è¡Œæµç¨‹ï¼Œä¹Ÿæœ‰åšä¸ç”¨åŒ¹é…æ‹¬è™Ÿçš„è™•ç†ï¼ŒåŒæ¨£éƒ½ç·¨è­¯æˆæ©Ÿå™¨ç¢¼ï¼Œæ•ˆæœæ€éº¼å·®é€™éº¼å¤š ? é€™è£¡æˆ‘æƒ³äº†å¾ˆä¹…ï¼Œå¾Œä¾†æ‰ç™¼ç¾æ˜¯ compiler è¼¸å‡ºçš„çµ„åˆèªè¨€ï¼Œæœ‰åšå°å°å„ªåŒ–çš„å‹•ä½œğŸ˜‚

å…ˆçœ‹ sed çš„çµ„åˆèªè¨€ï¼Œåœ¨ `sed_BF.s`æª”æ¡ˆ
```asm
main:                                   # @main
	.cfi_startproc
# %bb.0:
	pushq	%rbp
	.cfi_def_cfa_offset 16
	.cfi_offset %rbp, -16
	movq	%rsp, %rbp
	.cfi_def_cfa_register %rbp
	subq	$32, %rsp
	movl	$1, %eax
	movl	%eax, %edi
	movl	$10000, %eax            # imm = 0x2710
	movl	%eax, %esi
	movl	$0, -4(%rbp)
	callq	calloc
	movq	%rax, -16(%rbp)
	movq	-16(%rbp), %rax
	movb	(%rax), %cl
	addb	$1, %cl
	movb	%cl, (%rax)
	movq	-16(%rbp), %rax
	movb	(%rax), %cl
	addb	$1, %cl
	movb	%cl, (%rax)
	movq	-16(%rbp), %rax
	movb	(%rax), %cl
	addb	$1, %cl
	movb	%cl, (%rax)
	movq	-16(%rbp), %rax
	movb	(%rax), %cl
	addb	$1, %cl
	movb	%cl, (%rax)
	movq	-16(%rbp), %rax
	movb	(%rax), %cl
	addb	$1, %cl
	movb	%cl, (%rax)
	movq	-16(%rbp), %rax
	movb	(%rax), %cl
	addb	$1, %cl
	movb	%cl, (%rax)
	movq	-16(%rbp), %rax
	movb	(%rax), %cl
	addb	$1, %cl
	movb	%cl, (%rax)
	movq	-16(%rbp), %rax
	movb	(%rax), %cl
	addb	$1, %cl
	movb	%cl, (%rax)
	movq	-16(%rbp), %rax
	movb	(%rax), %cl
        ...
```

å†çœ‹ compiler è¼¸å‡ºçš„çµ„åˆèªè¨€ï¼Œåœ¨`mandelbrot-compiler.s`æª”æ¡ˆ
```asm
main:
    pushq %rbp
    movq %rsp, %rbp
    pushq %r12
    subq $30008, %rsp
    leaq (%rsp), %rdi
    movl $0, %esi
    movq $30000, %rdx
    call memset
    movq %rsp, %r12
    incb (%r12)
    incb (%r12)
    incb (%r12)
    incb (%r12)
    incb (%r12)
    incb (%r12)
    incb (%r12)
    incb (%r12)
    incb (%r12)
    incb (%r12)
    incb (%r12)
    incb (%r12)
    incb (%r12)
    cmpb $0, (%r12)
    je bracket_0_end
```

sedçš„çµ„åˆæ²’æœ‰å„ªåŒ–ä¹‹å‰ï¼ŒåŸ·è¡ŒåŠ æ³•æ™‚è¦å…©å€‹å‹•ä½œ`mov`è·Ÿ`add`ï¼Œè€Œæˆ‘å€‘æ’°å¯«çš„compiler åªæœ‰ä½¿ç”¨ `incb`ä¸€æ¢æŒ‡ä»¤åšåŠ æ³•ï¼Œå› æ­¤å…‰æ˜¯ç¨‹å¼ç¢¼çš„å¤§å°ï¼Œå°±å·®äº†å››å€å±…å¤šã€‚
```bash
cat mandelbrot-compiler.s | wc -l # 14215 è¡Œ
cat sed_BF.s | wc -l # 41725 è¡Œ
```
**å› æ­¤æˆ‘å€‘å¯ä»¥å¾—å‡ºä¸€å€‹çµæœï¼Œå°±æ˜¯çµ„åˆèªè¨€ç¨‹å¼ç¢¼å­˜åœ¨å¤§é‡å†—é¤˜ï¼Œå› æ­¤æ‹–å®æ•´å€‹åŸ·è¡Œæ•ˆç‡ã€‚** åœ¨ä¸‹ä¸€å€‹éšæ®µçš„æ¢è¨ï¼Œæˆ‘å€‘å°‡å¤šåšç·¨è­¯å™¨çš„å„ªåŒ–ï¼Œå†é€²è¡Œæ¯”è¼ƒã€‚


# äºŒã€ç¬¬äºŒéšæ®µ(Stage 2) æ•ˆç‡æ¯”è¼ƒ - å„ªåŒ– sed
å†ç¬¬ä¸€éšæ®µï¼Œæåˆ°è‡ªè£½ compiler ç”¢ç”Ÿçµ„èª æ­é… clang æ¯” sed è½‰æˆ sed.c æ­é… clang ç”¢ç”Ÿçš„åŸ·è¡Œæª”é‚„å¿«ï¼Œæ˜¯å› ç‚º sed çš„æ–¹æ³•å­˜åœ¨å¤§é‡å†—é¤˜çš„æ“ä½œã€‚æ¥ä¸‹ä¾†æˆ‘å€‘å°‡è©¦è©¦çœ‹ï¼Œå° sed è½‰æˆçš„`.c`æª”ç·¨è­¯æ™‚åŠ å…¥æœ€ä½³åŒ–çš„é¸é …ã€‚**å…ˆé€²åˆ° stage 2 çš„è³‡æ–™å¤¾**
```bash
make
```
æ¥ä¸‹ä¾†ç¸½å…±å¾—åˆ°äº”å€‹æª”æ¡ˆï¼Œcompiler, sed, sed_O1, sed_O2, sed_O3ã€‚æˆ‘å€‘åŸ·è¡Œå®Œç”¢ç”Ÿå‡ºåœ–å¦‚ä¸‹
![](https://i.imgur.com/3pk4Ohi.png)

æˆ‘å€‘å¯ä»¥è§€å¯Ÿå‡ºï¼Œåœ¨ç·¨è­¯æ™‚å¤šäº†æœ€ä½³åŒ–çš„é¸é …ï¼Œsed åŸ·è¡Œé€Ÿåº¦ç›´æ¥å¿« 18 å€ï¼Œé‚£æ˜¯å› ç‚ºå¼·å¤§çš„ç·¨è­¯å™¨å¹«æˆ‘å€‘æœ€ä½³åŒ– sed.cï¼Œåˆªé™¤å¤§é‡å†—é¤˜çš„ç¨‹å¼ç¢¼ï¼Œé€Ÿåº¦ç›´æ¥ä¸Šå‡å¾ˆå¤šã€‚ä½†æˆ–è¨±æ˜¯ç¨‹å¼ç¢¼å¯ä»¥åœ¨ O1 æ™‚å°±æœ€ä½³åŒ–ï¼Œæ‰€ä»¥ O2, O3 å°±æ²’æœ‰é¡¯è‘—æå‡...
> é¡Œå¤–è©±: å„ªåŒ–æœ‰å¾ˆå¤šé¸é …ï¼Œå°ç¨‹å¼ç¢¼å¤§å°å„ªåŒ–ã€å°é€Ÿåº¦å„ªåŒ–ï¼Œæƒ³è¦æ·±å…¥ç†è§£å¯ä»¥å»ç ”ç©¶å„ªåŒ–æŒ‡ä»¤ï¼Œé€™è£¡åªç°¡å–®åˆ—èˆ‰å‡ºå¹¾å€‹æœ€å¸¸è¦‹çš„å„ªåŒ–æ–¹å¼

ä½ å¯èƒ½æœƒå¥½å¥‡ï¼Œé‚£æŠŠ compiler çš„ç”¢ç”Ÿçµ„åˆèªè¨€å†ä¸Ÿçµ¦ç·¨è­¯å™¨åšå„ªåŒ–ä¸å°±åˆæ›´å¿« ? é€™å€‹æˆ‘ä¹Ÿå¥½å¥‡éï¼Œæˆ‘æ‰¾åˆ°ä¸‹åˆ—è§£ç­”

[Does gcc-optimize assembly source file](https://stackoverflow.com/questions/64670576/does-gcc-optimize-assembly-source-file) 

å…¶å¯¦**æ²’è¾¦æ³•ğŸ˜‚**ï¼Œå…§å®¹æåˆ°
```
GCC passes your assembly source through the preprocessor and then to the assembler. At no time are any optimisations performed.
```
æœ€ä½³åŒ–çš„æ™‚æ©Ÿæ˜¯ç·¨è­¯åŸå§‹ç¢¼åˆ°çµ„èªéšæ®µï¼Œå¦‚æœç›´æ¥è¼¸å…¥çµ„èªçµ„è­¯æˆå¯åŸ·è¡Œæª”ï¼Œå°±æ²’æœ‰æ©Ÿæœƒå¯ä»¥æœ€ä½³åŒ–ã€‚

å†ä¾†çœ‹ä¸€ä¸‹çµ„èªç¨‹å¼ç¢¼è¡Œæ•¸
```bash
cat sed_BF.s | wc -l      # 41725 
cat sed_BF_O1.s | wc -l   # 8206
cat sed_BF_O2.s | wc -l   # 10265
cat sed_BF_O3.s | wc -l   # 10345
cat mandelbrot-compiler.s | wc -l  # 14215
```
å¯ä»¥çœ‹åˆ°æœ€ä½³åŒ–é¸é …ä¸ä¸€å®šå’Œç¨‹å¼ç¢¼è¡Œæ•¸æˆæ­£æ¯”ï¼Œä½†æ˜¯å·²ç¶“æ¶ˆé™¤å¤§é‡å†—é¤˜ã€‚å› æ­¤æ¯”æˆ‘å€‘è‡ªå·±å¯«çš„ç·¨è­¯å™¨ç”¢å‡ºçš„ 14215 è¡Œé‚„å°‘ 4000 - 6000 è¡Œã€‚æŒ‡ä»¤è®Šå¾—å¾ˆç²¾ç°¡ï¼Œé‚£æƒ³ç•¶ç„¶çˆ¾ï¼Œä¸€å®šè®Šå¾—æ¯”è¼ƒå¿«ã€‚ğŸ˜ 

# ä¸‰ã€æœ€å¾Œæ¯”è¼ƒåŠç¸½çµ
ç›´æ¥åœ¨ part 3 è³‡æ–™å¤¾åŸ·è¡Œï¼Œå¾—åˆ°æœ€çµ‚æ¯”è¼ƒçµæœ
```
make 
```

```
       program     real    user  system  Execution Time
0  interpreter  2:15.74  133.65    0.10          133.75
1          sed  0:18.82   17.82    0.01           17.83
2     compiler  0:03.84    3.68    0.00            3.68
3       sed_O1  0:01.38    1.29    0.00            1.29
4       sed_O2  0:01.15    1.10    0.01            1.11
5       sed_O3  0:01.10    1.09    0.00            1.09
```

![](https://i.imgur.com/THDeMo1.png)

* é€™è£¡å¯¦ä½œçš„ interpreter æ¯”è¼ƒæ…¢ï¼Œå› ç‚ºè¦èŠ± O(n) æ‰¾é…å°æ‹¬è™Ÿ
* sedçš„æ–¹æ³•åœ¨ç·¨è­¯å™¨å„ªåŒ–å‰ï¼Œæ¯”æˆ‘å€‘å¯¦åšçš„BFç·¨è­¯å™¨é‚„è¦æ…¢ï¼Œæ˜¯å› ç‚ºsedçš„çµ„åˆèªè¨€å­˜åœ¨å¤§é‡å†—é¤˜æ“ä½œ
* sedçš„æ–¹æ³•å„ªåŒ–å¾Œï¼Œå¯ä»¥æ¯”æˆ‘å€‘å¯¦åšçš„BFç·¨è­¯å™¨å¿«
* å¾æœ€ç°¡å–®æ²’å„ªåŒ–çš„interpreteråˆ°å„ªåŒ–çš„sedï¼Œå¿«äº†è¿‘ 130å€å·¦å³

åœ¨ä¸‹ä¸€å€‹ Partï¼Œæˆ‘å€‘å°‡å¯¦ä½œ JIT compilerï¼Œä¸¦ä¸”é€²è¡Œæœ€å¾Œæ¯”è¼ƒğŸ¤£

# å››ã€å°ˆæ¡ˆä½¿ç”¨æ–¹æ³•
1.  æ¸¬è©¦ stage-1, stage-2 æ™‚ï¼Œå…ˆé€²åˆ°å„å€‹è³‡æ–™å¤¾
```sh
make test
```
å³å¯è¼¸å‡ºåŸ·è¡Œæ™‚é–“è³‡æ–™

2. ç­‰ stage-1, stage-2 çš„æ¸¬è©¦åŸ·è¡Œè³‡æ–™å®Œæˆå¾Œï¼Œåˆ° Part 3 è³‡æ–™å¤¾åŸ·è¡Œ
```
sh test.sh
``` 
å³å¯è¼¸å‡ºæ¯”è¼ƒé•·æ¢åœ–


# åƒè€ƒé€£çµ
1. [Does GCC optimize assembly source file?](https://stackoverflow.com/questions/64670576/does-gcc-optimize-assembly-source-file)

2. [Gcc optimize option](https://gcc.gnu.org/onlinedocs/gcc/Optimize-Options.html)

3. [Relative performance of x86 inc vs. add instruction](https://stackoverflow.com/questions/5993326/relative-performance-of-x86-inc-vs-add-instruction)

4. [Optimisation for a brainfuck interpreter](https://stackoverflow.com/questions/6853548/optimisation-for-a-brainfuck-interpreter)