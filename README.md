# Just In Time Compiler

# Why Compiler ?  
1. ç‚ºä»€éº¼éœ€è¦ç·¨è­¯å™¨ ? ç‚ºäº†æ›´å¿«ã€æ›´æœ‰æ•ˆç‡çš„ä½¿ç”¨ç¡¬é«”ï¼Œå¦‚ CPUã€GPUç­‰ï¼Œä¹Ÿå¸Œæœ›ç¨‹å¼ç¢¼å¯ä»¥è·‘åœ¨ä¸åŒç¡¬é«”å¹³å°ä¸Š 

2. å“ªè£¡æœ‰ç·¨è­¯å™¨çš„å½±å­ ? åˆ°è™•éƒ½æ˜¯ã€‚å¦‚ Google V8, Pypy, Flacc, Java, .NET, Android ART, OpenGL ([where to find compiler](http://slide.logan.tw/compiler-intro/#/4/2))


3. LLVM ç·¨è­¯å™¨æ¡†æ¶ï¼Œå› ç‚ºçµ±ä¸€äº† IR ä»¥åŠå° IR çš„å„ªåŒ–ï¼Œå†ä¹Ÿä¸ç”¨å› ç‚ºåŸ·è¡Œå¹³å°çš„ä¸åŒè¦èŠ±å¤§é‡æ™‚é–“é‡æ–°è¨­è¨ˆï¼Œå¯ä»¥å¹«åŠ©æˆ‘å€‘å¿«é€Ÿå»ºç«‹ä¸€å€‹ Compilerï¼Œç¾åœ¨å¾ˆå¤šç·¨è­¯å™¨éƒ½ä½¿ç”¨ LLVM é–‹ç™¼ï¼ŒLLVM ä¹Ÿæœ‰è±å¯Œçš„ç·¨è­¯è¼¸å‡º (ARM, x86, Alpha, PowerPC)ï¼ŒLLVMçš„å‡ºç¾ï¼Œè®“ä¸åŒçš„å‰ç«¯åç«¯ä½¿ç”¨çµ±ä¸€çš„LLVM IR ,å¦‚æœéœ€è¦æ”¯æŒæ–°çš„ç¨‹å¼èªè¨€æˆ–è€…æ–°çš„è¨­å‚™å¹³å°ï¼Œåªéœ€è¦é–‹ç™¼å°æ‡‰çš„å‰ç«¯å’Œå¾Œç«¯å³å¯ã€‚åŒæ™‚åŸºæ–¼LLVM IRæˆ‘å€‘å¯ä»¥å¾ˆå¿«çš„é–‹ç™¼è‡ªå·±çš„ç¨‹å¼èªè¨€ã€‚

   ![](https://pic3.zhimg.com/80/v2-64db6352bd23eb839ea4517ff70f2ba2_1440w.png)

    ä¹Ÿå› æ­¤ï¼Œ**LLVMçµ±ä¸€çš„IRæ˜¯å®ƒæˆåŠŸçš„é—œéµä¹‹ä¸€ï¼Œä¹Ÿå……åˆ†èªªæ˜äº†ä¸€å€‹å„ªç§€IRçš„é‡è¦æ€§**ã€‚IRå¯ä»¥èªªæ˜¯ä¸€ç¨®è† æ°´èªè¨€ï¼Œæ³¨é‡é‚è¼¯è€Œå»æ‰äº†å¹³å°ç›¸é—œçš„å„ç¨®ç‰¹æ€§ï¼Œé€™æ¨£ç‚ºäº†æ”¯æŒä¸€ç¨®æ–°èªè¨€æˆ–æ–°ç¡¬é«”éƒ½æœƒéå¸¸æ–¹ä¾¿

4. æ ¹æ“š[æ­¤ç¯‡æ–‡ç« ](https://zhuanlan.zhihu.com/p/65452090)æåˆ°æœ‰é™çš„ç²¾åŠ›è·Ÿç„¡é™çš„ç®—åŠ›ï¼Œæ·±åº¦å­¸ç¿’ç·¨è­¯æŠ€è¡“æ‰æœƒè¶Šä¾†è¶Šé‡è¦ï¼Œäººæœƒç‰¹å®šå»æœ€ä½³åŒ–æŸäº›ç®—å­(å·ç©)ï¼Œè€Œä¸ä¸€å®šé©ç”¨ç¶²è·¯çš„æ¯ä¸€å±¤ã€‚ä½†æ·±åº¦å­¸ç¿’ç·¨è­¯å™¨å¯ä»¥å¹«åŠ©æˆ‘å€‘é€²è¡Œé‡å°ç¶²è·¯çš„æ¯ä¸€å±¤é€²è¡Œæœ€ä½³åŒ–ï¼Œé€šéï¼ˆæ¥è¿‘ç„¡é™ï¼‰çš„ç®—åŠ›å»é©é…æ¯ä¸€å€‹æ‡‰ç”¨å ´æ™¯çœ‹åˆ°çš„ç¶²çµ¡ï¼Œé€™æ˜¯æ·±åº¦å­¸ç¿’ç·¨è­¯å™¨æ¯”äººå·¥è·¯ç·šå¼·çš„åœ°æ–¹ã€‚**ç·¨è­¯å™¨å¯ä»¥é”åˆ°æ›´å¤šçš„è‡ªå‹•åŒ–**ï¼Œä»¥ä¸‹ç¯€éŒ„è‡³è©²æ–‡ç« 
   >ç•¶æ¯”è¼ƒTVMå’Œå‚³çµ±æ–¹æ³•çš„æ™‚å€™çš„æ™‚å€™ï¼Œæˆ‘å€‘å¾€å¾€æœƒç™¼ç¾ï¼šåœ¨æ¨™æº–çš„benchmarkï¼ˆå¦‚imagenet resnetï¼‰ä¸Šï¼Œç·¨è­¯å¸¶ä¾†çš„æå‡å¯èƒ½åªåœ¨10%åˆ°20%ï¼Œä½†æ˜¯ä¸€æ—¦æ¨¡å‹ç›¸å°ä¸æ¨™æº–åŒ–ï¼ˆå¦‚æœ€è¿‘çš„OctConvï¼ŒDeformable,ç”šè‡³æ˜¯åŒæ¨£çš„resnetä¸åŒçš„è¼¸å…¥å°ºå¯¸ï¼‰ï¼Œç·¨è­¯æŠ€è¡“å¯ä»¥å¸¶ä¾†çš„æå‡æœƒéå¸¸å·¨å¤§ã€‚åŸå› ä¹Ÿéå¸¸ç°¡å–®ï¼Œæœ‰é™çš„ç²¾åŠ›ä½¿å¾—åƒèˆ‡å„ªåŒ–çš„äººå¾€å¾€é—œæ³¨æœ‰é™çš„å…¬é–‹æ¨™æº–benchmarkï¼Œä½†æ˜¯æˆ‘å€‘çš„éƒ¨ç½²ç›®æ¨™å¾€å¾€ä¸¦éé€™äº›benchmarkï¼Œè‡ªå‹•åŒ–å¯ä»¥ç„¡å·®åˆ¥åœ°å°æˆ‘å€‘é—œå¿ƒçš„å ´æ™¯é€²è¡Œç‰¹æ®Šå„ªåŒ–ã€‚æ¥è¿‘ç„¡é™çš„ç®—åŠ›å’Œæœ‰é™çš„ç²¾åŠ›çš„å·®åˆ¥æ­£æ˜¯ç‚ºä»€éº¼ç·¨è­¯æŠ€è¡“ä¸€å®šæœƒè¶Šä¾†è¶Šé‡è¦çš„åŸå› ã€‚

   å¦å¤–ï¼Œä¸€å€‹è¼ƒæ–°çš„æŠ€è¡“ - TVMï¼Œå¼•å…¥ `graph compiler`ï¼Œå°‡æ·±åº¦å­¸ç¿’çš„æ¨¡å‹è½‰æˆ graph IRï¼Œå° IR é€²è¡Œæœ€ä½³åŒ–å¾Œï¼Œå¯ä»¥è·‘åœ¨å¦‚æ‰‹æ©Ÿé€™ç¨®ç¡¬é«”è³‡æºè¼ƒä½çš„ç§»å‹•å¼è£ç½®(ç•¶ç„¶æœƒæ¨æ£„ç²¾åº¦æ¸›å°‘è¨ˆç®—é‡ï¼Œåœ¨ç²¾åº¦å’Œæ•ˆç‡ä¹‹é–“é€²è¡Œå–æ¨)ã€‚å’Œå‚³çµ±ç·¨è­¯å™¨ä¸åŒçš„æ˜¯ï¼Œé€™é¡ç·¨è­¯å™¨ä¸å…‰è¦è§£æ±ºè·¨å¹³å°ï¼Œé‚„æœ‰è§£æ±ºå°ç¥ç¶“ç¶²çµ¡æœ¬èº«çš„æœ€ä½³åŒ–å•é¡Œï¼Œé€™æ¨£åŸå…ˆä¸€å±¤çš„IRå°±é¡¯å¾—é é ä¸å¤ ï¼ŒåŸå› åœ¨æ–¼å¦‚æœè¨­è¨ˆä¸€å€‹æ–¹ä¾¿ç¡¬ä»¶æœ€ä½³åŒ–çš„ä½éšçš„èªè¨€ï¼Œä½ å¹¾ä¹å¾ˆé›£å¾ä¸­æ¨ç†ä¸€äº›ç¥ç¶“ç¶²è·¯ä¸­é«˜éšçš„æ¦‚å¿µé€²è¡Œæœ€ä½³åŒ–

![](https://pic3.zhimg.com/80/v2-cf84dfa43008de15457e188adca9a582_1440w.png) 

![](https://pic2.zhimg.com/80/v2-4f45f71b8e9e0338924e689a8c3b021d_1440w.png)
   å¦å¤–TVMçš„å°æ‰‹ï¼ŒXLAï¼ˆåŠ é€Ÿç·šæ€§ä»£æ•¸ï¼‰æ˜¯é‡å°ç·šæ€§ä»£æ•¸çš„ç‰¹å®šé ˜åŸŸç·¨è­¯å™¨ï¼Œå¯å„ªåŒ–TensorFlowè¨ˆç®—ã€‚çµæœæ˜¯åœ¨æœå‹™å™¨å’Œç§»å‹•å¹³å°ä¸Šæé«˜äº†é€Ÿåº¦ï¼Œè¨˜æ†¶é«”ä½¿ç”¨ç‡å’Œå¯ç§»æ¤æ€§ã€‚

![](https://pic2.zhimg.com/80/v2-18d0443d567986dc4f34d23e4daa890d_1440w.jpg?source=1940ef5c)

   


ç¸½çµä¾†èªªï¼Œå› ç‚ºæ ¹æ“šæ‘©çˆ¾å®šå¾‹ï¼Œç¡¬é«”æ™¶ç‰‡æ•ˆèƒ½ç´„æ¯éš”å…©å¹´ä¾¿æœƒå¢åŠ ä¸€å€ï¼Œä½†æ˜¯è¿‘ä¾†è¨ˆç®—èƒ½åŠ›çš„éœ€æ±‚çˆ†ç‚¸æ€§çš„å¢åŠ ï¼Œä¾‹å¦‚æ·±åº¦å­¸ç¿’ï¼Œä»¥åŠè¨ˆç®—æ©Ÿæ¶æ§‹çš„å¤šæ¨£æ€§ï¼Œæ‘©çˆ¾å®šå¾‹é€æ¼¸è·Ÿä¸ä¸Šè¨ˆç®—èƒ½åŠ›çš„éœ€æ±‚ï¼Œæ‰€ä»¥æˆ‘å€‘éœ€è¦ç·¨è­¯å™¨ï¼Œé‡å°æœ‰é™è³‡æºçš„ç¡¬é«”åŠæ¶æ§‹ç”¢å‡ºæœ€ä½³åŒ–ã€æ•ˆç‡æœ€é«˜çš„ç¨‹å¼ç¢¼

# Compiler Language vs Interpreter Language
> [åƒè€ƒé€£çµ](https://github.com/yaofly2012/note/issues/193)

è·Ÿæ“šç¿»è­¯çš„æ–¹å¼ï¼Œåˆ†ç‚ºç·¨è­¯å™¨å’Œç›´è­¯å™¨ï¼Œä»¥ä¸‹ç‚ºå…©è€…æ¯”è¼ƒ

|     | ç·¨è­¯å™¨ | ç›´è­¯å™¨ |
|-----|--------| --------|
|åŸ·è¡Œ| è¦å…ˆç·¨è­¯å†åŸ·è¡Œ| ä¸ç”¨äº‹å…ˆç·¨è­¯ |
|å•Ÿå‹•| æ…¢ (è¦ç­‰ç·¨è­¯) | å¿«(ä¸ç”¨äº‹å…ˆç·¨è­¯) |
|åŸ·è¡Œæ•ˆç‡| å¿«ï¼Œç·¨è­¯æ™‚é‚„å¯ä»¥äº‹å…ˆå„ªåŒ– | æ…¢ |
| é‡ç·¨è­¯ | ä¸ç”¨ | æ¯æ¬¡å•Ÿå‹•éƒ½è¦é‡ç·¨è­¯ |
| è·¨å¹³å° | å·®ï¼Œéœ€è¦é‡ç·¨è­¯  | å¥½

å¦å¤–åƒ JVMï¼Œåœ¨ ç·¨è­¯ å’Œ ç›´è­¯ ä¹‹é–“åšä¸€å€‹å–æ¨
1.  å…ˆç·¨è­¯æˆä¸­é–“æ–‡ä»¶ ( Bytecode)
2.  å†ç›´è­¯åŸ·è¡Œï¼Œä¸¦æ­é… JIT compiler çš„ runtime å„ªåŒ–

æ­¤æ™‚ JIT Compiler å¼•å…¥ï¼Œä½¿æˆ‘å€‘å¯ä»¥é”åˆ°å‹•æ…‹ç·¨è­¯çš„æŠ€è¡“
![](https://camo.githubusercontent.com/a19600604970dcbe59dec105638e9607e3e3ffccf5fd4512f74c13facb77ca2e/68747470733a2f2f696d6167652d7374617469632e7365676d656e746661756c742e636f6d2f3235362f3339392f3235363339393336352d356638326235653666303438615f61727469636c6578)

 
`Baseline compiler` : ç·¨è­¯çš„å–®ä½æ˜¯ç¨‹å¼ç¢¼è¡Œï¼ˆstubï¼‰

`Optimizing compiler` : ç·¨è­¯å’Œå„ªåŒ–çš„å–®ä½ç‚ºå‡½æ•¸



# å°ˆæ¡ˆç›®æ¨™
|Part|ç›®æ¨™| é€²åº¦ |
|----|----| ----- | 
|Part 1. Simple JIT| åˆ©ç”¨ Dynasm å¹«åŠ©å»ºç«‹ç°¡å–®çš„ JIT | âœ”
|Part 2. BF compiler| å»ºç«‹ç°¡å–®çš„ Brainfuck compiler å’Œ interpreter | ğŸ’¨(ing)|
|Part 3. BF JIT| åˆ©ç”¨ Dynasm å¹«åŠ©å»ºç«‹ BF JITï¼Œä»¥åŠåšä¸€äº›å„ªåŒ–æ¸¬è©¦ | âŒ |


# åƒè€ƒé€£çµ
1. [Deep Learningçš„IRä¹‹çˆ­](https://zhuanlan.zhihu.com/p/29254171)

2. [JS åŠæ™‚ç·¨è­¯å™¨ Just-In-Time (JIT) compilers](https://github.com/yaofly2012/note/issues/193)

3. [What Can Compilers Do for Us?](https://www.slideshare.net/jserv/what-can-compilers-do-for-us/16-LLVM)

4. [ç‚ºä»€éº¼é€™éº¼å¤šäººå–œæ­¡å¯«ç·¨è­¯å™¨ï¼Ÿ](https://www.zhihu.com/question/39304476)

5. [è™›æ“¬æ©Ÿå™¨è¨­è¨ˆèˆ‡å¯¦ä½œ](https://hackmd.io/@sysprog/SkBsZoReb?type=view)

6. [æ·±åº¦å­¸ç¿’ç·¨è­¯æŠ€è¡“çš„ç¾ç‹€å’Œæœªä¾†](https://zhuanlan.zhihu.com/p/65452090)

7. [æ·±åº¦å­¸ç¿’ç·¨è­¯å™¨å­¸ç¿’ç­†è¨˜å’Œå¯¦è¸é«”æœƒ (å¥½å°ˆæ¬„!) ](https://www.zhihu.com/column/c_1169609848697663488)